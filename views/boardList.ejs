<section class="notice">
    <div class="page-title">
        <div class="container">
          <br><br>
          <h3 class="text-center">자유게시판</h3>
        </div>
    </div>
    <div class="container">
      <nav class="sp_nav">
        <a class="sp_nav-link" href="/boardList/병원">병원</a>
        <a class="sp_nav-link" href="/boardList/자랑">자랑</a>
        <a class="sp_nav-link" href="/boardList/기타">기타</a>
        <a class="sp_nav-link" href="/boardList" >전체보기</a>
      </nav>
    </div>

  
    <!-- board list area -->
    <div id="board-list">
        <div class="container">
            <table id="my-table" class="table table-hover">
                <thead>
                <tr>
                    <th scope="col" class="th-num">번호</th>
                    <th scope="col" class="th-ctg">카테고리</th>
                    <th scope="col" class="th-title">제목</th>
                    <th scope="col" class="th-writer">작성자</th>
                    <th scope="col" class="th-date">등록일</th>
                </tr>
                </thead>
              <tbody id="table-body">
                <% for (let i = 0; i < posts.data.length ; i++) {
                    const post = posts.data[i];
                    const created_at = post.created_at.toLocaleString(); %>
                
                <tr id="table-row">
                    <td scope="row"><%= post.post_id %></td>
                    <td><a href="/boardList/<%= post.category %>"><%= post.category %></a></td> 
                    <th><a href='/boardDetail/<%= post.post_id %>'><%= post.title %> </a></th>
                    <td><%= post.user?.nickname %></td>
                    <td><%= created_at %></td>
                </tr>
                <% } %>
              </tbody>
            </table>
            <!-- <button onclick="viewBoardLists(document.querySelectorAll('tr')[document.querySelectorAll('tr').length - 1].getElementsByTagName('td')[0].textContent)" id="moreBtn" type="button" class="btn btn-outline-secondary">더보기</button> -->
            <button onclick="viewBoardLists(<%= posts.pageOpt.endCursor %>)" id="moreBtn" type="button" class="btn btn-outline-secondary">더보기</button>
    
        </div>
    </div>
    
    <div>
      </div>

    <div class="container">
      <a href='/board/post' class="btn btn-success">글쓰기</a>
    </div>
    <br><br>

</section>

<script>
  async function viewBoardLists(endPostId) {
    if (endPostId === -1) {
			return;
		}

    $.ajax({
      type: 'GET',
      async: "true",
      url: `/posts?endCursor=${endPostId}`,
      success: function (response) {
        const table = document.getElementById('my-table').getElementsByTagName('tbody')[0];
        const tr = document.querySelectorAll('tr');
        const lastRowInTable = tr[tr.length - 1];

        if (response.data.length === 0) {
          const tempHTML =  `
                          <tr>
                    <td scope="row"></td>
                    <td></td> 
                    <td style='margin: 10px auto'>마지막 항목입니다</td>
                    <td></td>
                    <td></td>
                </tr>
            `
          const newRow = table.insertRow(table.rows.length);
          newRow.innerHTML = tempHTML;

          // 버튼 업데이트
          const moreButton = document.getElementById('moreBtn')
          moreButton.setAttribute('onClick', `viewBoardLists(-1)`)
          return;
        }

        response.data.forEach(post => {
          const html = `
                          <tr>
                    <td scope="row">${post.post_id}</td>
                    <td><a href="/boardList/${post.category}">${post.category}</a></td> 
                    <th><a href='/boardDetail/${post.post_id}'>${post.title}</a></th>
                    <td>${post.user?.nickname}</td>
                    <td>${post.created_at.toLocaleString()}</td>
                </tr>
          `;
          const newRow = table.insertRow(table.rows.length);
          newRow.innerHTML = html;
        })

        // 버튼 업데이트
        const moreButton = document.getElementById('moreBtn')
        moreButton.setAttribute('onClick', `viewBoardLists(${response.pageOpt.endCursor})`)

      },
      error: function (err) {
        console.log(err);
      },
    });
  }


</script>
